<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä Excel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            color: #555;
        }

        .user-info {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info strong {
            color: #2c3e50;
        }

        .logout-form {
            display: inline;
        }

        .logout-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .logout-button:hover {
            background-color: #c0392b;
        }

        h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }

        p {
            color: #666;
            text-align: center;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .form-group {
            margin: 20px 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        select, input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #fff;
            font-size: 16px;
            box-sizing: border-box;
        }

        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
        }

        .submit-button {
            width: 100%;
            padding: 14px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .submit-button:hover {
            background-color: #0056b3;
        }

        .submit-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .admin-actions {
            margin: 30px 0;
            text-align: center;
        }

        .admin-button {
            display: inline-block;
            padding: 12px 24px;
            background-color: #ffc107;
            color: #212529;
            text-decoration: none;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
        }

        .admin-button:hover {
            background-color: #e0a800;
        }

        .no-formats {
            text-align: center;
            padding: 30px 20px;
            background-color: #fdf6e3;
            border: 1px solid #fae588;
            border-radius: 6px;
            color: #8a6d3b;
            font-style: italic;
        }

        #message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        #message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ) */
        .flash-message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
        }

        .flash-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .flash-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>

<!-- –®–∞–ø–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ä–æ–ª—å, –∫–æ–º–ø–∞–Ω–∏—è -->
<div class="header">
    <div class="user-info">
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong th:text="${#authentication?.principal?.username} ?: '–ì–æ—Å—Ç—å'">–ì–æ—Å—Ç—å</strong>,
        —Ä–æ–ª—å: <strong th:text="${#authentication?.principal?.role?.title} ?: '‚Äî'">‚Äî</strong>,
        –∫–æ–º–ø–∞–Ω–∏—è: <strong th:text="${#authentication?.principal?.company?.companyName} ?: '‚Äî'">‚Äî</strong>
    </div>
    <form class="logout-form" th:action="@{/logout}" method="post">
        <button type="submit" class="logout-button">–í—ã–π—Ç–∏</button>
    </form>
</div>

<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ (–æ—à–∏–±–∫–∞/—É—Å–ø–µ—Ö) -->
<div th:if="${error}" class="flash-message error" th:text="${error}"></div>
<div th:if="${success}" class="flash-message success" th:text="${success}"></div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
<h2>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä Excel</h2>
<p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.</p>

<form id="convertForm" enctype="multipart/form-data">
    <div class="form-group">
        <label for="converterType">–§–æ—Ä–º–∞—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:</label>

        <!-- –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ -->
        <div th:if="${#lists.isEmpty(formats)}" class="no-formats">
            ‚ùå –£ –≤–∞—à–µ–π —Ä–æ–ª–∏ –∏/–∏–ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.<br>
            –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ -->
        <select
                id="converterType"
                name="converterType"
                th:disabled="${#lists.isEmpty(formats)}"
                required
                th:if="${!#lists.isEmpty(formats)}"
        >
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç --</option>
            <option th:each="format : ${formats}"
                    th:value="${format.type}"
                    th:text="${format.label}">
            </option>
        </select>
    </div>

    <div class="form-group">
        <label for="file">Excel-—Ñ–∞–π–ª (.xlsx, .xls):</label>
        <input type="file" id="file" name="file" accept=".xlsx,.xls" required/>
    </div>

    <button type="submit" class="submit-button">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
</form>

<!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ AJAX (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞) -->
<div id="message"></div>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
<div class="admin-actions" sec:authorize="hasRole('ADMIN')">
    <a href="/admin/update-dictionaries" class="admin-button">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
    </a>
</div>
<!-- –¢–æ–ª—å–∫–æ –¥–ª—è ADMIN -->
<div class="admin-actions" sec:authorize="hasRole('ADMIN')">
    <a href="/admin/pending-users" class="admin-button">
        üë• –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    </a>
</div>
<script>
    document.getElementById('convertForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏
        submitBtn.disabled = true;
        submitBtn.textContent = "–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º...";

        try {
            const response = await fetch('/convert', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // ‚úÖ –£—Å–ø–µ—Ö: —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const blob = await response.blob();

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ Content-Disposition
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'converted.xlsx';
                if (contentDisposition) {
                    const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+)/i);
                    if (utf8Match) {
                        filename = decodeURIComponent(utf8Match[1]);
                    } else {
                        const fallback = contentDisposition.match(/filename="?(.+)"?/i);
                        if (fallback) filename = fallback[1];
                    }
                }

                // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showMessage('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!', 'success');
                this.reset();

            } else {
                // ‚ùå –û—à–∏–±–∫–∞: —á–∏—Ç–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Ç–µ–ª–∞
                const errorText = await response.text();
                showMessage('‚ùå –û—à–∏–±–∫–∞: ' + errorText, 'error');
            }

        } catch (error) {
            showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + (error.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ'), 'error');
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showMessage(text, type) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = type; // success –∏–ª–∏ error
        messageEl.style.display = 'block';
    }
</script>
</body>
</html>