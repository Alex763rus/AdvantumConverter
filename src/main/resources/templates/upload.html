<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä Excel</title>
    <style> body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 680px;
        margin: 50px auto;
        padding: 20px;
        background-color: #f8f9fa;
        color: #333;
        line-height: 1.6;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #ddd;
        font-size: 14px;
        color: #555;
    }

    .user-info {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .user-info strong {
        color: #2c3e50;
        font-weight: 600;
    }

    .logout-form {
        display: inline;
    }

    .logout-button {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        font-weight: 500;
    }

    .logout-button:hover {
        background-color: #c0392b;
    }

    /* --- –ü–∞–Ω–µ–ª—å –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞ --- */
    .converter-panel {
        margin: 0 0 30px 0;
        padding: 20px;
        border: 1px solid #d0d7de;
        border-radius: 8px;
        background-color: #ffffff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .converter-panel h3 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: #2c3e50;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .converter-panel h3::before {
        content: "üìÑ";
    }

    .form-group {
        margin: 15px 0;
    }

    label {
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
        color: #444;
        font-size: 14px;
    }

    select, input[type="file"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: #fff;
        font-size: 15px;
        box-sizing: border-box;
    }

    select:focus, input[type="file"]:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
    }

    .submit-button {
        width: 100%;
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
    }

    .submit-button:hover {
        background-color: #0056b3;
    }

    .submit-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    /* --- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å --- */
    .admin-panel {
        margin: 30px 0;
        padding: 15px;
        border: 1px solid #d0d7de;
        border-radius: 8px;
        background-color: #f6f8fa;
        text-align: center;
    }

    .admin-panel h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #555;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .admin-panel h3::before {
        content: "‚öôÔ∏è";
    }

    .admin-actions {
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .admin-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background-color: #2c8ccb;
        color: white;
        text-decoration: none;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .admin-button:hover {
        background-color: #1a76b8;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .admin-button:active {
        transform: translateY(0);
    }

    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    .flash-message {
        margin: 15px 0;
        padding: 10px;
        border-radius: 6px;
        font-weight: bold;
        text-align: center;
    }

    .flash-message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .flash-message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    #message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 6px;
        font-weight: bold;
        text-align: center;
        display: none;
    }

    #message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    #message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 600px) {
        .admin-actions {
            flex-direction: column;
            align-items: center;
        }

        .admin-button {
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }
    } </style>
</head>
<body> <!-- –®–∞–ø–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ä–æ–ª—å, –∫–æ–º–ø–∞–Ω–∏—è -->
<div class="header">
    <div class="user-info"> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong
            th:text="${#authentication?.principal?.username} ?: '–ì–æ—Å—Ç—å'">–ì–æ—Å—Ç—å</strong>, —Ä–æ–ª—å: <strong
            th:text="${#authentication?.principal?.role?.title} ?: '‚Äî'">‚Äî</strong>, –∫–æ–º–ø–∞–Ω–∏—è: <strong
            th:text="${#authentication?.principal?.company?.companyName} ?: '‚Äî'">‚Äî</strong></div>
    <form class="logout-form" th:action="@{/logout}" method="post">
        <button type="submit" class="logout-button">–í—ã–π—Ç–∏</button>
    </form>
</div> <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ -->
<div th:if="${error}" class="flash-message error" th:text="${error}"></div>
<div th:if="${success}" class="flash-message success" th:text="${success}"></div> <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞ -->
<div class="converter-panel"><h3>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä Excel</h3>
    <p style="color: #666; font-size: 14px; margin: 0 0 15px 0;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.</p>
    <form id="convertForm" enctype="multipart/form-data">
        <div class="form-group"><label for="converterType">–§–æ—Ä–º–∞—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:</label>
            <div th:if="${#lists.isEmpty(formats)}"
                 style="color: #8a6d3b; background: #fdf6e3; padding: 10px; border-radius: 6px; font-style: italic; font-size: 14px;">
                ‚ùå –£ –≤–∞—à–µ–π —Ä–æ–ª–∏ –∏/–∏–ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.<br>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
            </div>
            <select id="converterType" name="converterType" th:disabled="${#lists.isEmpty(formats)}" required
                    th:if="${!#lists.isEmpty(formats)}">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç --</option>
                <option th:each="format : ${formats}" th:value="${format.type}" th:text="${format.label}"></option>
            </select></div>
        <div class="form-group"><label for="file">Excel-—Ñ–∞–π–ª (.xlsx, .xls):</label> <input type="file" id="file"
                                                                                           name="file"
                                                                                           accept=".xlsx,.xls"
                                                                                           required/></div>
        <button type="submit" class="submit-button">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </form>
</div> <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ AJAX -->
<div id="message"></div> <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
<div class="admin-panel" sec:authorize="hasRole('ADMIN')"><h3>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
    <div class="admin-actions"><a href="/admin/update-dictionaries" class="admin-button"> üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ </a> <a
            href="/admin/pending-users" class="admin-button"> üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ </a></div>
</div>
<script> document.getElementById('convertForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = "–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º...";
    try {
        const response = await fetch('/convert', {method: 'POST', body: formData});
        if (response.ok) {
            const blob = await response.blob();
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'converted.xlsx';
            if (contentDisposition) {
                const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+)/i);
                if (utf8Match) {
                    filename = decodeURIComponent(utf8Match[1]);
                } else {
                    const fallback = contentDisposition.match(/filename="?(.+)"?/i);
                    if (fallback) filename = fallback[1];
                }
            }
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showMessage('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!', 'success');
            this.reset();
        } else {
            const errorText = await response.text();
            showMessage('‚ùå –û—à–∏–±–∫–∞: ' + errorText, 'error');
        }
    } catch (error) {
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + (error.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ'), 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});

function showMessage(text, type) {
    const messageEl = document.getElementById('message');
    messageEl.textContent = text;
    messageEl.className = type;
    messageEl.style.display = 'block';
} </script>
</body>
</html>