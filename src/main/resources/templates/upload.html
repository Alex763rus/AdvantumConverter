<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä Excel</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π CSS -->
    <link rel="stylesheet" th:href="@{/css/upload.css}" href="/css/upload.css"/>
</head>
<body> <!-- –®–∞–ø–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ä–æ–ª—å, –∫–æ–º–ø–∞–Ω–∏—è -->
<div class="header">
    <div class="user-info"> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong
            th:text="${#authentication?.principal?.username} ?: '–ì–æ—Å—Ç—å'">–ì–æ—Å—Ç—å</strong> —Ä–æ–ª—å: <strong
            th:text="${#authentication?.principal?.role?.title} ?: '‚Äî'">‚Äî</strong> –∫–æ–º–ø–∞–Ω–∏—è: <strong
            th:text="${#authentication?.principal?.company?.companyName} ?: '‚Äî'">‚Äî</strong></div>
    <form class="logout-form" th:action="@{/logout}" method="post">
        <button type="submit" class="logout-button">–í—ã–π—Ç–∏</button>
    </form>
</div> <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ -->
<div th:if="${error}" class="flash-message error" th:text="${error}"></div>
<div th:if="${success}" class="flash-message success" th:text="${success}"></div> <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞ -->
<div class="converter-panel"><h3>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä Excel</h3>
    <p style="color: #666; font-size: 14px; margin: 0 0 15px 0;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.</p>
    <form id="convertForm" enctype="multipart/form-data">
        <div class="form-group"><label for="converterType">–§–æ—Ä–º–∞—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:</label>
            <div th:if="${#lists.isEmpty(formats)}"
                 style="color: #8a6d3b; background: #fdf6e3; padding: 10px; border-radius: 6px; font-style: italic; font-size: 14px;">
                ‚ùå –£ –≤–∞—à–µ–π —Ä–æ–ª–∏ –∏/–∏–ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.<br>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
            </div>
            <select id="converterType" name="converterType" th:disabled="${#lists.isEmpty(formats)}" required
                    th:if="${!#lists.isEmpty(formats)}">
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç --</option>
                <option th:each="format : ${formats}" th:value="${format.type}" th:text="${format.label}"></option>
            </select></div>
        <div class="form-group"><label for="file">Excel-—Ñ–∞–π–ª (.xlsx, .xls):</label> <input type="file" id="file"
                                                                                           name="file"
                                                                                           accept=".xlsx,.xls"
                                                                                           required/></div>
        <button type="submit" class="submit-button">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </form>
</div> <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ AJAX -->
<div id="message"></div> <!-- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
<div class="admin-panel" sec:authorize="hasRole('ADMIN')"><h3>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
    <div class="admin-actions">
        <button type="button" class="admin-button" onclick="updateDictionaries()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</button>
        <a href="/admin/pending-users" class="admin-button"> üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ </a></div>
</div>
<script> document.getElementById('convertForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = "–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º...";
    try {
        const response = await fetch('/convert', {method: 'POST', body: formData});
        if (response.ok) {
            const blob = await response.blob();
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'converted.xlsx';
            if (contentDisposition) {
                const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+)/i);
                if (utf8Match) {
                    filename = decodeURIComponent(utf8Match[1]);
                } else {
                    const fallback = contentDisposition.match(/filename="?(.+)"?/i);
                    if (fallback) filename = fallback[1];
                }
            }
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showMessage('‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏ —Å–∫–∞—á–∞–Ω!', 'success');
            this.reset();
        } else {
            const errorText = await response.text();
            showMessage('‚ùå –û—à–∏–±–∫–∞: ' + errorText, 'error');
        }
    } catch (error) {
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + (error.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ'), 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});

function showMessage(text, type) {
    const messageEl = document.getElementById('message');
    messageEl.textContent = text;
    messageEl.className = type;
    messageEl.style.display = 'block';
}

async function updateDictionaries() {
    const button = document.querySelector('button[onclick="updateDictionaries()"]');
    const originalText = button.textContent;

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
    button.disabled = true;
    button.textContent = "–û–±–Ω–æ–≤–ª—è–µ–º...";

    try {
        const response = await fetch('/admin/update-dictionaries', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        });

        const message = await response.text();

        if (response.ok) {
            showMessage('‚úÖ ' + message, 'success');
        } else {
            showMessage('‚ùå ' + message, 'error');
        }
    } catch (error) {
        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
        button.disabled = false;
        button.textContent = originalText;
    }
}

</script>
</body>
</html>