<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

    <changeSet author="Grigogiev Alexey" id="create_schema_iabs_acc_product">
        <sql>
            <!-- Liquibase lock update для PostgreSQL -->
            UPDATE DATABASECHANGELOGLOCK SET LOCKED=FALSE, LOCKGRANTED=null, LOCKEDBY=null where ID=1;

            <!-- Таблица car -->
            CREATE TABLE IF NOT EXISTS car
            (
                car_id          BIGSERIAL PRIMARY KEY,
                car_name        VARCHAR(255),
                pallet          INTEGER,
                temperature_max INTEGER,
                temperature_min INTEGER,
                tonnage         INTEGER
                );

            <!-- Таблица car_number -->
            CREATE TABLE IF NOT EXISTS car_number
            (
                car_number_id BIGSERIAL PRIMARY KEY,
                number        VARCHAR(255)
                );

            <!-- Таблица company -->
            CREATE TABLE IF NOT EXISTS company
            (
                company_id   BIGSERIAL PRIMARY KEY,
                company_name VARCHAR(255)
                );

            <!-- Таблица faq -->
            CREATE TABLE IF NOT EXISTS faq
            (
                faq_id    BIGSERIAL PRIMARY KEY,
                answer    VARCHAR(255),
                file_path VARCHAR(255),
                question  VARCHAR(255)
                );

            <!-- Таблица history_action -->
            CREATE TABLE IF NOT EXISTS history_action
            (
                history_action_id  BIGSERIAL PRIMARY KEY,
                action_date        TIMESTAMP,
                action_type        SMALLINT,
                callback_menu_name VARCHAR(255),
                chat_id_from       BIGINT NOT NULL,
                chat_id_to         BIGINT,
                file_name          VARCHAR(255),
                message_text      VARCHAR(1000)
                );

            <!-- Таблица lenta_car -->
            CREATE TABLE IF NOT EXISTS lenta_car
            (
                car_number VARCHAR(255) PRIMARY KEY,
                ax         BIGINT,
                model      VARCHAR(255),
                region     VARCHAR(255),
                tonnage    INTEGER,
                vin        VARCHAR(255),
                year_issue BIGINT
                );

            <!-- Таблица lenta_dictionary -->
            CREATE TABLE IF NOT EXISTS lenta_dictionary
            (
                lenta_dictionary_key BIGINT PRIMARY KEY,
                address_name         VARCHAR(255),
                type                 SMALLINT,
                region               VARCHAR(255),
                time_shop            VARCHAR(255),
                time_stock           VARCHAR(255)
                );

            <!-- Таблица metro_addresses_dictionary -->
            CREATE TABLE IF NOT EXISTS metro_addresses_dictionary
            (
                addresses_id   VARCHAR(255) PRIMARY KEY,
                addresses_name VARCHAR(255)
                );

            <!-- Таблица metro_dc_addresses_dictionary -->
            CREATE TABLE IF NOT EXISTS metro_dc_addresses_dictionary
            (
                addresses_id    VARCHAR(255) PRIMARY KEY,
                addresses_brief VARCHAR(255),
                addresses_name  VARCHAR(255)
                );

            <!-- Таблица metro_temperature_dictionary -->
            CREATE TABLE IF NOT EXISTS metro_temperature_dictionary
            (
                temperature_id  VARCHAR(255) PRIMARY KEY,
                max_temperature BIGINT,
                min_temperature BIGINT
                );

            <!-- Таблица metro_time_dictionary -->
            CREATE TABLE IF NOT EXISTS metro_time_dictionary
            (
                code       VARCHAR(255) NOT NULL,
                priority   BIGINT NOT NULL,
                time_id    BIGINT NOT NULL,
                time_end   VARCHAR(255),
                time_start VARCHAR(255),
                PRIMARY KEY (code, priority, time_id)
                );

            <!-- Таблица ozon_dictionary -->
            CREATE TABLE IF NOT EXISTS ozon_dictionary
            (
                ozon_dictionary_id BIGSERIAL PRIMARY KEY,
                stock_brief        VARCHAR(255),
                stock_in_time      VARCHAR(255),
                stock_out_time     VARCHAR(255)
                );

            <!-- Таблица ozon_load_unload_time -->
            CREATE TABLE IF NOT EXISTS ozon_load_unload_time
            (
                arrival     VARCHAR(255) PRIMARY KEY,
                load_time   INTEGER,
                unload_time INTEGER
                );

            <!-- Таблица ozon_tonnage_time -->
            CREATE TABLE IF NOT EXISTS ozon_tonnage_time
            (
                tonnage BIGINT PRIMARY KEY,
                time    VARCHAR(255)
                );

            <!-- Таблица ozon_transit_time -->
            CREATE TABLE IF NOT EXISTS ozon_transit_time
            (
                arrival      VARCHAR(255) NOT NULL,
                departure    VARCHAR(255) NOT NULL,
                transit_time VARCHAR(255),
                PRIMARY KEY (arrival, departure)
                );

            <!-- Таблица support_task -->
            CREATE TABLE IF NOT EXISTS support_task
            (
                support_task_id  BIGSERIAL PRIMARY KEY,
                close_at         TIMESTAMP,
                converter_name   VARCHAR(255),
                employee_chat_id BIGINT,
                error_text       VARCHAR(255),
                file_path        VARCHAR(255),
                message_id       INTEGER,
                registered_at    TIMESTAMP,
                result_text      VARCHAR(255),
                support_chat_id  BIGINT,
                task_state       SMALLINT
                );

            <!-- Таблица user_tbl -->
            CREATE TABLE IF NOT EXISTS user_tbl
            (
                chat_id       BIGINT PRIMARY KEY,
                first_name    VARCHAR(255),
                last_name     VARCHAR(255),
                registered_at TIMESTAMP,
                user_name     VARCHAR(255),
                user_role     SMALLINT,
                company_id    BIGINT NOT NULL,
                CONSTRAINT fk_user_company
                FOREIGN KEY (company_id)
                REFERENCES company (company_id)
                ON DELETE RESTRICT
                );

            <!-- Создание индексов для улучшения производительности -->
            CREATE INDEX IF NOT EXISTS idx_user_tbl_company_id ON user_tbl(company_id);
            CREATE INDEX IF NOT EXISTS idx_history_action_chat_id_from ON history_action(chat_id_from);
            CREATE INDEX IF NOT EXISTS idx_history_action_action_date ON history_action(action_date);
            CREATE INDEX IF NOT EXISTS idx_support_task_registered_at ON support_task(registered_at);
            CREATE INDEX IF NOT EXISTS idx_support_task_task_state ON support_task(task_state);

            <!-- Комментарии к таблицам -->
            COMMENT ON TABLE user_tbl IS 'Пользователи системы';
            COMMENT ON TABLE company IS 'Компании пользователей';
            COMMENT ON TABLE history_action IS 'История действий пользователей';
            COMMENT ON TABLE support_task IS 'Задачи поддержки';
        </sql>
    </changeSet>
</databaseChangeLog>